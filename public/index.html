<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ö—Ä–æ–∫–æ–¥–∏–ª: –≤–µ–¥—É—â–∏–π –∏ –∏–≥—Ä–æ–∫–∏</title>
    <style>
        body { font-family: sans-serif; }
        canvas { border: 1px solid black; cursor: crosshair; display: block; margin-bottom: 10px; }
        #log { border: 1px solid #000; height: 150px; overflow-y: auto; padding: 5px; }
    </style>
</head>
<body>
    <h1>–ö—Ä–æ–∫–æ–¥–∏–ª</h1>
    <p id="role-info">–í–∞—à–∞ —Ä–æ–ª—å: ...</p>

    <canvas id="canvas" width="800" height="400"></canvas>

    <input id="msg" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <div id="log"></div>

    <script>
        const ws = new WebSocket(`ws://${location.host}`);
        const log = document.getElementById('log');
        const input = document.getElementById('msg');
        const btn = document.getElementById('send');
        const roleInfo = document.getElementById('role-info');

        let role = null;

        function addLog(text) {
            const div = document.createElement('div');
            div.textContent = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        ws.onopen = () => addLog('üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);

            if (data.type === 'role') {
                role = data.role;
                roleInfo.textContent = `–í–∞—à–∞ —Ä–æ–ª—å: ${role === 'leader' ? '–í–µ–¥—É—â–∏–π' : '–ò–≥—Ä–æ–∫'}`;
                if (role === 'leader') {
                    input.disabled = true;
                    btn.disabled = true;
                }
                if (role === 'player') {
                    canvas.style.pointerEvents = 'none';
                }
            }

            if (data.type === 'chat') {
                addLog(`üí¨ ${data.text}`);
            }
            if (data.type === 'draw') {
                drawLine(data.prevX, data.prevY, data.x, data.y, false);
            }
        };

        btn.onclick = sendMessage;
        input.onkeydown = (e) => { if (e.key === 'Enter') sendMessage(); };

        function sendMessage() {
            const text = input.value.trim();
            if (text && role === 'player') {
                ws.send(JSON.stringify({ type: 'chat', text }));
                input.value = '';
            }
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let prevX = 0, prevY = 0;

        canvas.addEventListener('mousedown', (e) => {
            if (role !== 'leader') return;
            drawing = true;
            prevX = e.offsetX;
            prevY = e.offsetY;
        });

        canvas.addEventListener('mouseup', () => {
            if (role !== 'leader') return;
            drawing = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!drawing || role !== 'leader') return;
            const x = e.offsetX;
            const y = e.offsetY;
            drawLine(prevX, prevY, x, y, true);
            prevX = x;
            prevY = y;
        });

        function drawLine(x1, y1, x2, y2, emit) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            if (!emit) return;
            ws.send(JSON.stringify({ type: 'draw', prevX: x1, prevY: y1, x: x2, y: y2 }));
        }
    </script>
</body>
</html>