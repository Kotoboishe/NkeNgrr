<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket —Ä–∏—Å–æ–≤–∞–ª–∫–∞ + —á–∞—Ç</title>
    <style>
        body { font-family: sans-serif; }
        canvas { border: 1px solid black; cursor: crosshair; display: block; margin-bottom: 10px; }
        #log { border: 1px solid #000; height: 150px; overflow-y: auto; padding: 5px; }
    </style>
</head>
<body>
    <h1>–†–∏—Å–æ–≤–∞–ª–∫–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π</h1>

    <canvas id="canvas" width="800" height="400"></canvas>

    <input id="msg" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <div id="log"></div>

    <script>
        const ws = new WebSocket(`ws://${location.host}`);
        const log = document.getElementById('log');
        const input = document.getElementById('msg');
        const btn = document.getElementById('send');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç
        function addLog(text) {
            const div = document.createElement('div');
            div.textContent = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        ws.onopen = () => addLog('üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);

            if (data.type === 'system') {
                addLog(`üõà ${data.text}`);
            }
            if (data.type === 'chat') {
                addLog(`üí¨ ${data.text}`);
            }
            if (data.type === 'draw') {
                drawLine(data.prevX, data.prevY, data.x, data.y, false);
            }
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        btn.onclick = sendMessage;
        input.onkeydown = (e) => { if (e.key === 'Enter') sendMessage(); };

        function sendMessage() {
            const text = input.value.trim();
            if (text) {
                ws.send(JSON.stringify({ type: 'chat', text }));
                input.value = '';
            }
        }

        // –õ–æ–≥–∏–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let prevX = 0, prevY = 0;

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            prevX = e.offsetX;
            prevY = e.offsetY;
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            const x = e.offsetX;
            const y = e.offsetY;
            drawLine(prevX, prevY, x, y, true);
            prevX = x;
            prevY = y;
        });

        function drawLine(x1, y1, x2, y2, emit) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            if (!emit) return;
            ws.send(JSON.stringify({ type: 'draw', prevX: x1, prevY: y1, x: x2, y: y2 }));
        }
    </script>
</body>
</html>